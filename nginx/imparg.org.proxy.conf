# imparg.org — CONFIG UNIFICADA PROXY
# Colocar en: /etc/nginx/sites-available/imparg.org (en el PROXY)
# Enlazar: ln -s /etc/nginx/sites-available/imparg.org /etc/nginx/sites-enabled/
# Sitios: / + /impa-static/ + /media/ → IMPA (VM 192.168.1.51:5010) | /intranet → 5020 | /webmail | /stream | /archivos

########################
#  HTTP: redirigir a HTTPS
########################
server {
    listen 80;
    listen [::]:80;
    server_name imparg.org www.imparg.org;

    # Let's Encrypt / Certbot (renovación)
    location ^~ /.well-known/acme-challenge/ {
        root /var/www/certbot;
        allow all;
    }

    location / {
        return 301 https://$host$request_uri;
    }
}

################################
#  HTTPS (443) — bloque principal
################################
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name imparg.org www.imparg.org;

    # Certificados SSL (Let's Encrypt con certbot)
    ssl_certificate     /etc/letsencrypt/live/imparg.org/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/imparg.org/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;

    # Intranet (Máquina IMPA 192.168.1.51, puerto 5020)
    location /intranet/ {
        proxy_pass http://192.168.1.51:5020/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Script-Name /intranet;
        proxy_set_header X-Forwarded-Prefix /intranet;
    }

    # Webmail (Roundcube en máquina correo .30) — acceso por /webmail
    location /webmail {
        proxy_pass http://192.168.1.30/roundcube/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Roundcube genera URLs /roundcube/skins/..., /roundcube/plugins/... — hay que proxyearlas
    location /roundcube/ {
        proxy_pass http://192.168.1.30/roundcube/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Stream de audio (máquina 192.168.1.40, puerto 3000)
    location /stream/ {
        proxy_pass http://192.168.1.40:3000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_buffering off;
        proxy_request_buffering off;
        proxy_cache off;
        proxy_max_temp_file_size 0;
        proxy_connect_timeout 60s;
        proxy_send_timeout 3600s;
        proxy_read_timeout 3600s;
    }

    # API de FileBrowser (la app en /archivos llama a /api/...)
    location /api/ {
        proxy_pass http://192.168.1.40:3001/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }

    # Archivos / subir archivos (máquina 192.168.1.40, puerto 3001)
    location /archivos/ {
        proxy_pass http://192.168.1.40:3001/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Prefix /archivos;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }

    # Estáticos Django (app principal IMPA, VM 192.168.1.51:5010) — /impa-static/ para no chocar con FileBrowser
    location /impa-static/ {
        proxy_pass http://192.168.1.51:5010/impa-static/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 30s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # Medios Django (uploads, IMPA 192.168.1.51:5010)
    location /media/ {
        proxy_pass http://192.168.1.51:5010/media/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 30s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # Estáticos de FileBrowser (la app en /archivos pide /static/...)
    location /static/ {
        proxy_pass http://192.168.1.40:3001/static/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Favicons que la app pide pero el backend no tiene: evita 404 en consola
    location = /static/img/icons/favicon.ico { return 204; }
    location = /static/img/icons/favicon.svg { return 204; }

    # Raíz → aplicación principal IMPA (VM 192.168.1.51, puerto 5010)
    # Si proxy-common.conf también define Host/X-Forwarded-Proto, se duplican y Django recibe "imparg.org,imparg.org".
    # La app IMPA ya normaliza eso; opcional: no incluir el snippet aquí o que el snippet no redefina Host.
    location / {
        proxy_pass http://192.168.1.51:5010/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 30s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;
        include /etc/nginx/snippets/proxy-common.conf;
    }
}
